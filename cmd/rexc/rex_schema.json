{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "rules": {
      "type": "array",
      "uniqueItems": true,
      "items": {
        "allOf": [
          {
            "$ref": "#/definitions/ruleWithUniqueName"
          },
          {
            "type": "object",
            "properties": {
              "name": {
                "description": "The name of the rule.  Must be unique.",
                "type": "string"
              },
              "priority": {
                "type": "integer",
                "description": "The priority of the rule.  The lower the number, the higher the priority.  Defaults to 10.",
                "minimum": 1,
                "default": 10
              },
              "conditions": {
                "type": "object",
                "properties": {
                  "all": {
                    "$ref": "#/definitions/conditionGroup"
                  },
                  "any": {
                    "$ref": "#/definitions/conditionGroup"
                  }
                },
                "oneOf": [{ "required": ["all"] }, { "required": ["any"] }]
              },
              "actions": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "type": {
                      "type": "string",
                      "enum": ["updateStore", "sendMessage", "runScript"]
                    },
                    "target": {
                      "type": "string",
                      "pattern": "^[^:]+:[^:]+$"
                    },
                    "value": {
                      "type": ["string", "number", "boolean"],
                      "description": "This can also be a reference to a script name defined in the 'scripts' section."
                    },
                    "customProperty": {
                      "type": "object"
                    }
                  },
                  "required": ["type"],
                  "anyOf": [
                    { "required": ["target", "value"] },
                    { "required": ["script"] }
                  ],
                  "additionalProperties": false
                }
              },
              "scripts": {
                "type": "object",
                "description": "An object where each property is a script name, and the value is a script definition.",
                "additionalProperties": {
                  "type": "object",
                  "properties": {
                    "params": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "The parameters to be passed to the script."
                    },
                    "body": {
                      "type": "string",
                      "description": "The JavaScript code to be executed by the Otto engine."
                    }
                  },
                  "required": ["body"],
                  "additionalProperties": false
                }
              }
            },
            "required": ["name", "conditions", "actions"],
            "additionalProperties": false
          }
        ]
      }
    }
  },
  "required": ["rules"],
  "definitions": {
    "ruleWithUniqueName": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string"
        }
      }
    },
    "conditionGroup": {
      "type": "array",
      "items": {
        "oneOf": [
          {
            "type": "object",
            "properties": {
              "fact": {
                "type": "string",
                "pattern": "^[^:]+:[^:]+$"
              },
              "operator": {
                "type": "string",
                "enum": [
                  "EQ",
                  "NEQ",
                  "LT",
                  "LTE",
                  "GT",
                  "GTE",
                  "CONTAINS",
                  "NOT_CONTAINS"
                ]
              },
              "value": {
                "type": ["string", "number", "boolean"]
              }
            },
            "required": ["fact", "operator", "value"],
            "additionalProperties": false
          },
          {
            "type": "object",
            "properties": {
              "all": {
                "$ref": "#/definitions/conditionGroup"
              },
              "any": {
                "$ref": "#/definitions/conditionGroup"
              }
            },
            "oneOf": [{ "required": ["all"] }, { "required": ["any"] }],
            "additionalProperties": false
          }
        ]
      }
    }
  }
}
